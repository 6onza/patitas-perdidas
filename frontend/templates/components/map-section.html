{% extends 'base.html' %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}
{% block content %}
<div  id ="map-section" class="map-container">
    <div class="col-lg-5">
      <form method="GET" id="search-form">
        <h2 class="text-secondary">Filtrar por:</h2>
        <div class="form-group">
          <label for="especie" class="mt-3 fw-bold">Especie</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="cat" name="cat" value="cat">
            <label class="form-check-label" for="cat">Gato</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="dog" name="dog" value="dog">
            <label class="form-check-label" for="dog">Perro</label>
          </div>
        </div>
        <div class="form-group">
          <label for="sexo">Sexo</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="male" name="male" value="male">
            <label class="form-check-label" for="male" class="fw-light">Macho</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="female" name="female" value="female">
            <label class="form-check-label" for="female" class="fw-light">Hembra</label>
          </div>
        </div>
        <div class="form-group">
          <label for="condicion">Condición</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="con-chapa" name="con-chapa" value="con-chapa">
            <label class="form-check-label" for="con-chapa" class="fw-light">Con chapa</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="sin-chapa" name="sin-chapa" value="sin-chapa">
            <label class="form-check-label" for="sin-chapa" class="fw-light">Sin chapa</label>
          </div>
        </div>
        <div class="form-group">
          <label for="provincia">Provincia</label>
          <input type="text" class="form-control" id="provincia" name="provincia" placeholder="Ingresa una provincia">
        </div>
        <div class="form-group">
          <label for="ciudad">Ciudad</label>
          <input type="text" class="form-control" id="ciudad" name="ciudad" placeholder="Ingresa una ciudad">
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i>
            Buscar
          </button>
        </div>
      </form>
    </div>
    <div class="col-lg-7">
        <div id="map"></div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
    // Pasar mascotas perdidas desde Flask a JavaScript
    var pets = {{ pets|tojson|safe }};

    // Inicialización del mapa
    var map = L.map("map").setView([-34.6037, -58.3816], 12);

    // Capa de OpenStreetMap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Icono de huella para mascotas perdidas
    var pawIcon = L.icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Crear marcador para cada mascota perdida
    pets.forEach((pet) => {
        // Verificar coordenadas válidas
        if (pet.lost_latitude && pet.lost_longitude) {
            var marker = L.marker([
                parseFloat(pet.lost_latitude), 
                parseFloat(pet.lost_longitude)
            ], { icon: pawIcon }).addTo(map);
            
            // Contenido del popup
            var popupContent = `
                <div style="text-align: center;">
                    <h3><b>${pet.pet_name}</b></h3>
                    <p><strong>Raza:</strong> ${pet.breed}</p>
                    <p><strong>Descripción:</strong> ${pet.description}</p>
                    <p><strong>Ubicación:</strong> ${pet.lost_location}</p>
                </div>
            `;
            
            marker.bindPopup(popupContent);
        }
    });

    // Ajustar el mapa al conjunto de marcadores si hay mascotas
    if (pets.length > 0) {
        var group = new L.featureGroup(
            pets.map(pet => 
                L.marker([parseFloat(pet.lost_latitude), parseFloat(pet.lost_longitude)])
            )
        );
        map.fitBounds(group.getBounds().pad(0.1));
    }
</script>
{% endblock %}